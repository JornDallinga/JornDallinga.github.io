---
title: "Proba-V"
author: "Jorn D"
date: "05-8-2016"
Version: "0.2 - beta (updated 19-8)"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
getwd()
```

## Preperation

This script has been tested and runs on a LINUX Centos machine, but might require some tweaking if used on other OS or versions. The data used within these scripts can be downloaded from http://proba-v.vgt.vito.be/ website. Lets start with loading the required libaries and packages to illustrate a workflow on working with the PROBA-V data.

```{r, message=F, warning=F}
# add additional libary path
.libPaths( c( .libPaths(), "~/R/x86_64-redhat-linux-gnu-library/3.2") )

## libaries
library(ranger)
library(raster)
library(ggvis)
library(rgdal)
library(dplyr)
library(devtools)
library(gdalUtils)
library(probaV)
library(tools)
library(knitr)

```



```{r, echo=F}
# set the knitR working directory to the same file location as getwd(), in order to maintain the link to R source scripts.
knitr::opts_knit$set(root.dir = "/home/pi/PROBA_V/ProbaV_JD")

```

```{r, message=F, warning=F}
# below the fixed link file in order to load the ProbaV package from Johannes
source("R/timeStackProbaV2.R")
source("R/processProbaVbatch2.R")
source("R/getHarmMetricsSpatial2.R")
source("R/mapDistance2Loess2.R")


```

## Data download

Lets download some data! Below an example on how to download the PROBA-V tiles by using coordinates. 

```{r}

# Select the location for which you wish to download the PROBA-V  tiles for. 
x <- 10.00
y <- 8.00

# In order to download the correct tile numbers, we use coordinates to convert to the tile number
tile <- probaVTileFromCoords(x, y)
tile <- paste("\'*",tile,"*\'", sep ="")

```

```{r, results='hide'}

# To download data from the PROBA-V vito website, we need to be a registerd user (free). We need the username and password, which you can enter below.
u_name <- readline("Type the username:")
p_word <- readline("Type the password:")


```


```{r}
# enter download location:
dirloc <- paste(getwd(), '/2015/', sep = "")

# Use wget to download the data. wget has be used directly in the terminal. Therefore, we pass the string to the system command.
wget_string <- paste('wget -A ', tile ,' -P ', dirloc, ' -r --user=', u_name,' --password=', p_word, ' http://www.vito-eodata.be/PDF/datapool/Free_Data/PROBA-V_300m/S1_TOC_-_300_m/2015/7/13/PV_S1_TOC-20150713_333M_V001/?mode=tif', sep="")

print(wget_string)

```


```{r, eval=FALSE}

# pass the string to the terminal directly from R.
system(wget_string)

```

## Preprocessing

---- check  downloaded data
Only GeoTIFF is accepted
The files should be stored in the folder structure used by vito
(One foler per date contains files for all tiles).


```{r, echo=F}

# set your data path
l0_dir <- "/DATA/GEOTIFF/PROBAV_L3_S5_TOC_100M"
```

start by setting our data path which contains the downloaded files

```{r, eval=F}
# variable setting for data path
10_dir <- "set data path"
```

The following function searches through the downloaded data folder and retrieves the product information, such as tiles and acquisition dates. Since the following functions only work on .tif files, we add '.tif$' to the pattern selection.
```{r}
df_probav_down <- getProbaVinfo(l0_dir, pattern = ".tif$")

# plot the retrieved data
df_probav_down %>% ggvis(x=~tile, fill=~band) %>% layer_bars()
```

## clean data 
```{r}
# apply SM mask and split radiometry tif into single layers
QC_val <- getProbaVQClist()$clear_all

patterns <- c('RADIOMETRY.tif$') # "NDVI.tif$" 'RADIOMETRY.tif$', 
#patterns <- list('RADIOMETRY.tif$', 'NDVI.tif$')
tiles <- c("X18Y02") #..., "X21Y06")

df_in <- getProbaVinfo(l0_dir, pattern = patterns, tiles = tiles)
#df_in %>% ggvis(x=~tile, fill=~band) %>% layer_bars()
nrow(df_in)

# check cores
detectCores(all.tests = FALSE, logical = TRUE)


```


